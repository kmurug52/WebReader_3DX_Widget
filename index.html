<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Visualization Color Tool</title>
    <script type="text/javascript" src="UWA.js"></script>
    <script>
        require.config({
            paths: { 'DS': 'https://3ddashboard.pdops.ds.ford.com/3ddashboard/resources/20250725T204009Z/en/webapps' }
        });
    </script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 15px; background: #ffffff; }
        .container { border: 1px solid #ddd; border-radius: 8px; padding: 15px; background: #fcfcfc; }
        .btn { width: 100%; padding: 12px; margin: 8px 0; border: none; border-radius: 4px; color: white; font-weight: bold; cursor: pointer; }
        .red { background: #d9534f; } .green { background: #5cb85c; } .blue { background: #428bca; }
        #statusLabel { font-size: 13px; margin-top: 15px; text-align: center; padding: 8px; border-radius: 4px; background: #eee; color: #555; }
    </style>
</head>
<body>
    <div class="container">
        <h3>Visual Overrides</h3>
        <button id="btnRed" class="btn red">Apply Red</button>
        <button id="btnGreen" class="btn green">Apply Green</button>
        <button id="btnBlue" class="btn blue">Apply Blue</button>
        <div id="statusLabel">Initializing...</div>
    </div>

    <script>
        require(['DS/PlatformAPI/PlatformAPI'], function (PlatformAPI) {
            let currentSelection = [];
            const status = document.getElementById('statusLabel');
            status.innerText = "Listening for 3D Selection...";

            // THE FIX: Listen to all 3 common selection channels used by Ford/3DS
            const channels = [
                'DS/Framework/Selection',
                'DS/3DPlay/Selection',
                'DS/3DNavigation/Selection'
            ];

            channels.forEach(channel => {
                PlatformAPI.subscribe(channel, function (data) {
                    console.log("Received selection from: " + channel, data);
                    
                    // Extract nodes/paths from the selection data
                    let nodes = data.paths || data.nodes || (data[0] ? data[0].paths : null);
                    
                    if (nodes && nodes.length > 0) {
                        currentSelection = nodes;
                        status.innerText = "SUCCESS: Part Found!";
                        status.style.background = "#e3f2fd";
                        status.style.color = "#1565c0";
                    }
                });
            });

            function applyColor(r, g, b) {
                if (currentSelection.length === 0) {
                    alert("Widget doesn't see the selection yet. Please click the part again.");
                    return;
                }
                
                const payload = {
                    nodes: currentSelection,
                    overrides: { color: { r: r, g: g, b: b }, opacity: 255 }
                };

                // Send to both possible command channels
                PlatformAPI.publish('DS/3DPlay/setVisualOverrides', payload);
                PlatformAPI.publish('DS/3DNavigation/setVisualOverrides', payload);
            }

            document.getElementById('btnRed').onclick = () => applyColor(255, 0, 0);
            document.getElementById('btnGreen').onclick = () => applyColor(0, 255, 0);
            document.getElementById('btnBlue').onclick = () => applyColor(0, 0, 255);
            
        });
    </script>
</body>
</html>
